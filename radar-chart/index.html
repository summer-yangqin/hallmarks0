<!DOCTYPE html>
<html>
<meta charset="utf-8">
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
<link rel="stylesheet" href="radar-chart.css">
<head>
  <style>
    body {
      padding: 20px;
    }
    .radar-chart .area {
      fill-opacity: 0.07;
    }
    .radar-chart.focus .area {
      fill-opacity: 0.03;
    }
    .radar-chart.focus .area.focused {
      fill-opacity: 0.09;
    }
    .area.germany, .germany .circle {
      fill: #FFD700;
      stroke: none;
    }
    .area.argentina, .argentina .circle {
      fill: #ADD8E6;
      stroke: none;
    }
  </style>
<style>
table { font-size: 10px; border-collapse: collapse; }
table th { border: 1px solid #aaa; }
table td { border: 1px solid #d0d0d0; }
.number { color: #09c; }
.mixed { color: #c90; }
.string { color: #90c; }
.time { color: #2c0; }
.boolean { color: #0b6; }
</style>


  <script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>
  <script type="text/javascript" src="radar-chart.js"></script>
  <script type="text/javascript" src="signatures.json"></script>


</head>
<body>
    <p>
     Select cancer tissue origin
    </p>
    <select id="cancer_tissue"> </select>

    <p>
     Upload a gene expression file  formated tab separated values (tsv) <br/>
    </p>
    <input type="file" id="uploader">
    <table id="input_table"> </table>
    <table id="output_table"> </table>


    </p>
    <script type="text/javascript">

      testdata = [
                  { className: "Sample1", axes: [
                          { "axis" :[ "Evading_growth_suppressors"], value:650 },
                          { "axis" :[ "Evading_immune_destruction"], value:780 },
                          { "axis" :[ "Genome_instability"],value: 670},
                          { "axis" :[ "Replicative_immortality"], value: 722},
                            { "axis" :[ "Reprogramming_energy_metabolism"], value: 600},
                            { "axis" :[ "Resisting_cell_death"], value: 590},
                            { "axis" :[ "Sustained_angiogenesis"], value: 880},
                            { "axis" :[ "Sustaining_proliferative_signaling"], value:810 },
                            { "axis" :[ "Tissue_invasion_and_metastasis"], value: 822},
                            { "axis" :[ "Tumor-promoting_inflammation"], value: 700 },
                   ] },
              ];

      function showRadar(data) {
          var chart = RadarChart.chart();

          var
              w = 600,
              h = 600;
          // console.log(data);


          RadarChart.defaultConfig.radius = 3;
          RadarChart.defaultConfig.w = w;
          RadarChart.defaultConfig.h = h;
          RadarChart.draw("#chart-container", data);

          function animate(elem, time) {
              if (!elem) return;
              var to = elem.offsetTop;
              var from = window.scrollY;
              var start = new Date().getTime(),
                  timer = setInterval(function() {
                      var step = Math.min(1, (new Date().getTime() - start) / time);
                      window.scrollTo(0, (from + step * (to - from)) + 1);
                      if (step == 1) {
                          clearInterval(timer);
                      };
                  }, 25);
              window.scrollTo(0, (from + 1));
          }

          var divVal = document.getElementById('chart-container');
          animate(divVal, 600);
      }

    </script>


    <div id="chart-container"></div>
    <script type="text/javascript">
        //RadarChart.defaultConfig.levelTick = true;
      </script>

    </body>

    <script>
    var X_UserData;
    var X_RankData;
    var X_SampleNames;
    var X_GeneMap = {};
    var X_Radar;


    function transpose(a) {
        return Object.keys(a[0]).map(function(c) {
                return a.map(function(r) { return r[c]; });
        });
    }

    function isNumeric(n) {
       return !isNaN(parseFloat(n)) && isFinite(n);
    }
    var Order =[];

    function RankNormalize(a) {
        var m = a.length; // m rows
        var n = a[0].length; // n columns
        var b = [];
        b.push(a[0]);

        for (var j = 1; j < m; j++)  { // foreach row
           var x = Array(n, 0.0);
           x.unshift(a[j][0]);
           b.push( x );
        }

        for (var i = 1; i < n; i++) { // foreach column
            var order = [];
            for (var j = 1; j < m; j++) { // foreach row
                var s = a[j][i];
                if (s == "LumA")
                  debugger;
                var nn = parseFloat(s);
                if (isNaN(nn)){
                   nn = 0.0;
               }
               order.push({n:nn, j:j});
            }
            order.sort( function (a, b) { return a.n - b.n; });
            
            var r = 6.0 / order.length;
            var s = -3.0;
            for (var o = 0; o < order.length; o++) { // foreach row
                var oo = order[o];
                b[oo.j][i] = s;
                // console.log(o, oo.j, oo.n, a[oo.j][i], b[oo.j][i], s) 
                s += r;
            }
        }
        return b;
    }

    function FormatForRadar(rect) {
        var m = rect.length; // m rows
        var n = rect[0].length; // n columns
        var radar = [];

        for (var i = 1; i < m; i++) { // foreach row
            var obj = {
                  className: rect[i][0],
                  axes: []
                };
            radar.push(obj);
            for (var j = 1; j < n; j++) { // foreach column
                obj.axes.push( { axis: [rect[0][j]], value:rect[i][j] } );
            }
        }
        return radar;
    }


    // load dataset and create table
    function load_dataset(tsv) {
      X_UserData = d3.tsv.parseRows(tsv)
      create_table_from_array_of_arrays("#input_table", X_UserData);
      X_Radar = FormatForRadar(X_UserData);

      showRadar(X_Radar);
    }

    // load dataset and create table
    function load_dataset0(tsv) {
      X_UserData = d3.tsv.parseRows(tsv)
      X_SampleNames = X_UserData[0];
      for (var i = 1; i < X_UserData.length; i++)
         X_GeneMap[X_UserData[i][0]] = i;

      create_table_from_array_of_arrays("#input_table", X_UserData);
      X_RankData = RankNormalize(X_UserData);
      X_Radar = CalculateHallmarks(X_UserData);
      showRadar(X_Radar);
    }

    // create a table with column headers, types, and data
    function create_table_from_array_of_objects(id, data) {
      var keys = d3.keys(data[0]);

      d3.select(id)
        .html("")
        .append("tr")
        .attr("class","fixed")
        .selectAll("th")
        .data(keys)
        .enter().append("th")
          .text(function(d) { return d; });

      d3.select(id)
        .selectAll("tr.row")
          .data(data)
        .enter().append("tr")
          .attr("class", "row")
          .selectAll("td")
          .data(function(d) { return keys.map(function(key) { return d[key] }) ; })
          .enter().append("td")
            .text(function(d) { return d; });
    }

    // create a table with column headers, types, and data
    function create_table_from_array_of_arrays(id, data) {
      var keys = data[0];

      d3.select(id)
        .html("")
        .append("tr")
        .attr("class","fixed")
        .selectAll("th")
        .data(keys)
        .enter().append("th")
          .text(function(d) { return d; });

      d3.select(id)
        .selectAll("tr.row")
          .data(data)
        .enter().append("tr")
          .attr("class", "row")
          .selectAll("td")
          .data(function(d) { return keys.map(function(key,i) { return d[i] }) ; })
          .enter().append("td")
            .text(function(d) { return d; });

    }

    function CalculateHallmarks(rank) {
        var sampleNames = rank[0];
        var n = sampleNames.length;
        var radar = [];
        var scoreMatrix  = [["GENE"]]

        for (var i = 0; i < n; i++) {
            radar.push({
              className: sampleNames[i],
              axes: []
            });
            scoreMatrix.push([sampleNames[i]]);
        }

        var ix = Y.index[d3.select('select').property('value')]


    

        for (var i = 0; i < ix.length; i++) {
            var sig = Y.signatures[ix[i]];
            var hallmark = sig.hallmark;
            scoreMatrix[0].push(hallmark);

            var scores = Array(n);

            // init with bias
            for (var j = 1; j < n; j++) {
                scores[j] = sig.b
            }


            for (var gene in sig.w) {
                // console.log(gene);

                var w = sig.w[gene];
                if (gene in X_GeneMap) {
                    var x = rank[X_GeneMap[gene]];
                    for (var j = 1; j < n; j++) {
                        scores[j] += w * x[j]; 
                    }
                }
            }

            for (var j = 1; j < n; j++) {
                radar[j].axes.push( { axis: [hallmark], value:scores[j] } );
                scoreMatrix[j].push(scores[j]);
            }
        }
        console.log(scoreMatrix)
        radar.shift();
        return {scoreMatrix: scoreMatrix, radar: radar};
    }

    // handle upload button
    function upload_button(el, callback) {
      var uploader = document.getElementById(el);  
      var reader = new FileReader();

      reader.onload = function(e) {
        var contents = e.target.result;
        callback(contents);
      };

      uploader.addEventListener("change", handleFiles, false);  

      function handleFiles() {
        d3.select("#table_input").text("loading...");
        var file = this.files[0];
        reader.readAsText(file);
      };
    };


    
    function select_tissue() {

        var data = Object.keys(Y.index);

        var select = d3.select('#cancer_tissue')
            .on('change',onchange)

        var options = select
          .selectAll('option')
                .data(data).enter()
                .append('option')
                        .text(function (d) { return d; });

        function onchange() {
                selectValue = d3.select('select').property('value')
                d3.select('body')
                        .append('p')
                        .text(selectValue + ' is the last selected option.')
        };
    };

    select_tissue();

    upload_button("uploader", load_dataset);
    </script>
</html>
